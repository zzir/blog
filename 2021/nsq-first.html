<!DOCTYPE html>
<html lang="zh"><head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="ZZIR">
    <meta name="description" content="FUN~">
    <meta name="keywords" content="zzir,Golang,Python,Docker,K8S">

    <link rel="stylesheet" href="/assets/css/style.css">

    <link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet"type="text/css">
    <link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css">
    <link rel="stylesheet" href="/assets/css/github.css">

    <title>NSQ é€‰å‹ç®€å•å¯¹æ¯”å’Œæµ‹è¯• - ZZIR's Note</title>
</head><body>
<main class="page-content" aria-label="Content">
    <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="post-back" id="post-back" style="display: none">
        <a class="black-link" href="https://zzir.cn">ğŸ™„</a>
    </div>
    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline">
            NSQ é€‰å‹ç®€å•å¯¹æ¯”å’Œæµ‹è¯•
        </h1>
        <p class="post-meta">
            <time class="dt-published" datetime="2021-03-02T00:00:00+08:00" itemprop="datePublished">Mar 2, 2021
            </time>ãƒ»
            <span itemprop="author" itemscope itemtype="http://schema.org/Person"
            ><span class="p-author h-card" itemprop="name">zzir</span></span
            ></p>
    </header>

    <div class="post-content e-content" itemprop="articleBody">
        <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>NSQ æ˜¯ä¸€ä¸ª Go å®ç°çš„å®æ—¶åˆ†å¸ƒå¼æ¶ˆæ¯å¹³å°ã€‚</p>
</div>
<div class="paragraph">
<p>æ–‡æ¡£ï¼šhttps://nsq.io/</p>
</div>
<div class="paragraph">
<p>æºç ï¼šhttps://github.com/nsqio/nsq</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ç‰¹æ€§">ç‰¹æ€§</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>support distributed topologies with no SPOF</p>
</li>
<li>
<p>horizontally scalable (no brokers, seamlessly add more nodes to the cluster)</p>
</li>
<li>
<p>low-latency push based message delivery (<a href="https://nsq.io/overview/performance.html">performance</a>)</p>
</li>
<li>
<p>combination load-balancedÂ <strong>and</strong>Â multicast style message routing</p>
</li>
<li>
<p>excel at both streaming (high-throughput) and job oriented (low-throughput) workloads</p>
</li>
<li>
<p>primarily in-memory (beyond a high-water mark messages are transparently kept on disk)</p>
</li>
<li>
<p>runtime discovery service for consumers to find producers (<a href="https://github.com/nsqio/nsq/tree/master/nsqlookupd/README.md">nsqlookupd</a>)</p>
</li>
<li>
<p>transport layer security (TLS)</p>
</li>
<li>
<p>data format agnostic</p>
</li>
<li>
<p>few dependencies (easy to deploy) and a sane, bounded, default configuration</p>
</li>
<li>
<p>simple TCP protocol supporting client libraries in any language</p>
</li>
<li>
<p>HTTP interface for stats, admin actions, and producers (<strong>no client library needed to publish</strong>)</p>
</li>
<li>
<p>integrates withÂ <a href="https://github.com/etsy/statsd/">statsd</a>Â for realtime instrumentation</p>
</li>
<li>
<p>robust cluster administration interface (<a href="https://github.com/nsqio/nsq/tree/master/nsqadmin/README.md">nsqadmin</a>)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="å’Œ-kafka-å¯¹æ¯”">å’Œ Kafka å¯¹æ¯”</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ç¼ºç‚¹ï¼š</p>
</div>
<div class="ulist">
<ul>
<li>
<p>æ¶ˆæ¯æŠ•é€’æ–¹å¼åªæ”¯æŒæœ€å°‘ä¸€æ¬¡</p>
</li>
<li>
<p>æ¶ˆæ¯ä¸ä¿è¯æœ‰åº</p>
</li>
<li>
<p>èŠ‚ç‚¹ä¸ä¿å­˜æ¶ˆæ¯å‰¯æœ¬</p>
</li>
<li>
<p>æ¶ˆæ¯åªæœ‰ PUSH æ¨¡å¼</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ä¼˜ç‚¹ï¼š</p>
</div>
<div class="ulist">
<ul>
<li>
<p>é…ç½®å’Œéƒ¨ç½²ç®€å•ï¼Œèµ„æºæ¶ˆè€—å°‘</p>
</li>
<li>
<p>è½»é‡ï¼Œæ²¡æœ‰ä¾èµ–ï¼ŒDebug æ–¹ä¾¿</p>
</li>
<li>
<p>æ”¯æŒæ°´å¹³æ‰©å±•</p>
</li>
<li>
<p>æ”¯æŒ SPOF çš„åˆ†å¸ƒå¼æ‹“æ‰‘</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="nsq-ç»„ä»¶">NSQ ç»„ä»¶</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><code>nsqd</code> ï¼šå®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒæ¥æ”¶ã€æ’é˜Ÿå¹¶å°†æ¶ˆæ¯ä¼ é€’ç»™å®¢æˆ·ç«¯ã€‚</p>
</li>
<li>
<p><code>nsqlookupd</code> ï¼šç®¡ç†æ‹“æ‰‘ä¿¡æ¯çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ¥å£ï¼šnsqd ä½¿ç”¨å®ƒçš„ TCP æ¥å£å¹¿æ’­ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨å®ƒçš„ HTTP æ¥å£å‘ç°å’Œç®¡ç†ã€‚</p>
</li>
<li>
<p><code>psqadmin</code> ï¼šä¸€ä¸ªç”¨äºå®æ—¶æŸ¥çœ‹èšåˆé›†ç¾¤ç»Ÿè®¡æ•°æ®å¹¶æ‰§è¡Œå„ç§ç®¡ç†ä»»åŠ¡çš„ Web UIã€‚</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>å®ƒè¿˜åŒ…å«ä¸€ç»„è¾…åŠ©å·¥å…·ï¼š</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://nsq.io/components/utilities.html#nsq_stat">nsq_stat</a></p>
</li>
<li>
<p><a href="https://nsq.io/components/utilities.html#nsq_tail">nsq_tail</a></p>
</li>
<li>
<p><a href="https://nsq.io/components/utilities.html#nsq_to_file">nsq_to_file</a></p>
</li>
<li>
<p><a href="https://nsq.io/components/utilities.html#nsq_to_http">nsq_to_http</a></p>
</li>
<li>
<p><a href="https://nsq.io/components/utilities.html#nsq_to_nsq">nsq_to_nsq</a></p>
</li>
<li>
<p><a href="https://nsq.io/components/utilities.html#to_nsq">to_nsq</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="å®¹å™¨éƒ¨ç½²">å®¹å™¨éƒ¨ç½²</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ä½¿ç”¨ Docker éƒ¨ç½²æµ‹è¯•ï¼Œä½¿ç”¨ <code>nsq_to_file</code> å°† <code>topic=test</code> çš„æ¶ˆæ¯æŒä¹…åŒ–åˆ°æœ¬åœ°ï¼Œå¿½ç•¥ç©ºç™½æ–‡ä»¶ï¼Œå¹¶å°†æŒä¹…åŒ–çš„æ•°æ®å‹ç¼©ã€‚</p>
</div>
<div class="listingblock">
<div class="title">docker-compose.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">version: '3'
services:
  nsqlookupd:
    image: nsqio/nsq
    command: /nsqlookupd
    ports:
      - "4160:4160"
      - "4161:4161"
  nsqd:
    image: nsqio/nsq
    command: /nsqd --lookupd-tcp-address=nsqlookupd:4160
    depends_on:
      - nsqlookupd
    ports:
      - "4150:4150"
      - "4151:4151"
  nsqadmin:
    image: nsqio/nsq
    command: /nsqadmin --lookupd-http-address=nsqlookupd:4161
    depends_on:
      - nsqlookupd
    ports:
      - "4171:4171"
  nsq_to_file:
    image: nsqio/nsq
    command: /nsq_to_file --gzip --lookupd-http-address=nsqlookupd:4161 --output-dir=/data --skip-empty-files --topic=test
    volumes:
      - ./nsq-data:/data
    depends_on:
      - nsqlookupd</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ç”Ÿäº§è€…">ç”Ÿäº§è€…</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">producer.go</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">package main

import (
	"fmt"
	"log"

	"github.com/nsqio/go-nsq"
)

func main() {
	config := nsq.NewConfig()

	producer, err := nsq.NewProducer("127.0.0.1:4150", config)
	if err != nil {
		log.Fatal(err)
	}

	messageBody := []byte("hello")
	topicName := "test"

	i := 10
	for i &gt; 0 {
		i--
		fmt.Println("&gt;", i)
		// å¼‚æ­¥å‘é€æ¶ˆæ¯
		_ = producer.PublishAsync(topicName, []byte(fmt.Sprintf("%s %d", messageBody, i)), nil)
	}

	producer.Stop()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>producer æä¾›äº† 6 ä¸ªæ–¹æ³•ç”¨æˆ·å‘å¸ƒæ¶ˆæ¯ï¼š</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Publish</code>ï¼šåŒæ­¥å‘é€æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p><code>PublishAsync</code>ï¼šå¼‚æ­¥å‘é€æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p><code>MultiPublish</code>ï¼šä¸€æ¬¡å‘é€å¤šä¸ªåŒæ­¥æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p><code>MultiPublishAsync</code>ï¼šä¸€æ¬¡å‘é€å¤šä¸ªå¼‚æ­¥æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p><code>DeferredPublish</code>ï¼šåŒæ­¥å»¶è¿Ÿå‘é€æ¶ˆæ¯ã€‚</p>
</li>
<li>
<p><code>DeferredPublishAsync</code>ï¼šå¼‚æ­¥å»¶è¿Ÿå‘é€æ¶ˆæ¯ã€‚</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="æ¶ˆè´¹è€…">æ¶ˆè´¹è€…</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">consumer.go</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">package main

import (
	"fmt"
	"log"
	"time"

	"github.com/nsqio/go-nsq"
)

type myMessageHandler struct{}

func (h *myMessageHandler) HandleMessage(m *nsq.Message) error {
	if len(m.Body) == 0 {
		return nil
	}

	fmt.Printf("&gt;&gt; %s, %s\n", m.ID, m.Body)

	return nil
}

func main() {
	config := nsq.NewConfig()
	config.MaxInFlight = 10 // é™æµ å®¢æˆ·ç«¯æ¥æ”¶æ¶ˆæ¯æ•°é‡

	consumer, err := nsq.NewConsumer("test", "channel", config)
	if err != nil {
		log.Fatal(err)
	}

	consumer.AddConcurrentHandlers(&amp;myMessageHandler{}, 5) // å¹¶å‘å¤„ç†æ¶ˆæ¯æ•°é‡

	err = consumer.ConnectToNSQD("127.0.0.1:4150")
	if err != nil {
		log.Fatal(err)
	}

	time.Sleep(time.Hour)
	consumer.Stop()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>NSQ æ¶ˆæ¯åªæ”¯æŒ <code>PUSH</code> æ¨¡å¼ï¼Œå½“ä¸Šæ¸¸çªå‘æµé‡æ—¶ï¼Œconsumer å¯ä»¥é€šè¿‡é…ç½® <code>MaxInFlight</code> å€¼æ¥è¾¾åˆ°é™æµçš„ç›®çš„ã€‚åŒæ—¶æ¶ˆè´¹ç«¯ä¹Ÿæ”¯æŒå¹¶å‘æ¥æ”¶æ¶ˆæ¯ã€‚</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="å‚è€ƒ">å‚è€ƒï¼š</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/nsqio/nsq" class="bare">https://github.com/nsqio/nsq</a></p>
</li>
<li>
<p><a href="https://nsq.io/" class="bare">https://nsq.io/</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/JoZSM/p/12443544.html" class="bare">https://www.cnblogs.com/JoZSM/p/12443544.html</a></p>
</li>
</ul>
</div>
</div>
</div>
    </div>

    <a class="u-url" href="/2021/nsq-first.html" hidden></a>
</article>

<div class="post-tags">
    
    <a>Go</a>
    
    <a>NSQ</a>
    
</div>

<div class="pagination">
    <ul>
        
        <li class="prev">
            <a href="/2021/converting-from-centos-linux-to-centos-stream.html" title="PREV: Converting from CentOS Linux to CentOS Stream">
                â€¹ Converting from CentOS Linux to CentOS Stream
            </a>
        </li>
        
        
    </ul>
</div>


<div class="giscus"></div>
<script src="https://giscus.app/client.js"
        data-repo="zzir/blog"
        data-repo-id="MDEwOlJlcG9zaXRvcnkyMTk2NjgyOTM="
        data-mapping="title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="light"
        crossorigin="anonymous"
        async>
</script>
    </div>
</main><footer>
    <p class="post-author"><a href="/">ZZIR</a></p>
</footer>
<script defer src="/assets/js/katex/katex.min.js" type="text/javascript"></script>
<script defer src="/assets/js/katex/auto-render.min.js" type="text/javascript"></script>
<script src="/assets/js/zooming.min.js" type="text/javascript"></script>
<script src="/assets/js/highlight.pack.js" type="text/javascript"></script>
<script>
    // zooming
    const zooming = new Zooming({
        customSize: '100%',
    });
    zooming.listen('.paragraph img');
    zooming.listen('.content img');
    zooming.listen('.post-content img');

    // highlight
    hljs.initHighlightingOnLoad();

    // katex
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false},
                {left: "\\(", right: "\\)", display: false},
                {left: "\\[", right: "\\]", display: true}
            ]
        });
    });

    // back display
    function getScrollTop() {
        var scrollTop = 0;
        if (document.documentElement && document.documentElement.scrollTop) {
            scrollTop = document.documentElement.scrollTop;
        } else if (document.body) {
            scrollTop = document.body.scrollTop;
        }
        return scrollTop;
    }

    window.onscroll = function () {
        if (getScrollTop() === 0) {
            document.getElementById("post-back").style.display = "block";
        }
    }
</script>


<script>
    // google analytics
    window.ga = window.ga || function () {
        (ga.q = ga.q || []).push(arguments)
    };
    ga.l = +new Date;
    ga('create', 'UA-121779014-1', 'auto');
    ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>