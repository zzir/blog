<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="zzir">
    <meta name="description" content="">
    <meta name="keywords" content="">
    
    <link rel="stylesheet" href="../css/style.css">
    
    <link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Caveat&display=swap" rel="stylesheet" type="text/css">
    
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css">
    <script defer src="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.js"></script>
    <script defer src="https://cdn.staticfile.org/KaTeX/0.11.1/contrib/auto-render.min.js"></script>
    
    <link rel="stylesheet" href="../css/github.css">
    <script src="../js/highlight.pack.js"></script>
    <title>Dockerfile And Registry - zzir</title>

    <script>
        hljs.initHighlightingOnLoad();
        document.addEventListener("DOMContentLoaded", function () {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ]
            });
        });
    </script>
</head>
<body>

    <main>
        <article>
            <h1 class="post-title">Dockerfile And Registry</h1>
            <div class="post-info">
                <p class="post-date">Oct 29, 2019</p>
            </div>
            <div class="post-content">
                


  
  
  



<table>
<thead>
<tr>
<th>环境</th>
<th>版本</th>
</tr>
</thead>

<tbody>
<tr>
<td>本地环境</td>
<td>macOS Catalina</td>
</tr>

<tr>
<td>远程环境</td>
<td>CentOS Linux release 7.7.1908 (Core)</td>
</tr>

<tr>
<td>Docker Engine</td>
<td>Community 19.03.2</td>
</tr>

<tr>
<td>Docker Compose</td>
<td>Version 1.24.1</td>
</tr>
</tbody>
</table>
<p>Docker 除了可以从官方镜像仓库下载和上传镜像，还可以使用 <code>Dockerfile</code> 自己编译镜像和使用私有或第三方镜像仓库。</p>

<h2 id="dockerfile">Dockerfile</h2>

<p><code>Dockerfile</code> 文件中包含用于自动构建镜像的指令，构建过程中，每条指令都会生成一个只读层，每一层都是上一层的增量，最后堆叠起来，构成了镜像。</p>

<h3 id="编译-go-实现的-http-服务">编译 Go 实现的 HTTP 服务：</h3>

<pre><code class="language-bash">git clone https://gist.github.com/d13f96506aebed11af6e6799f71acba4.git
cd d13f96506aebed11af6e6799f71acba4
vim Dockerfile
</code></pre>

<p>如果无法 Clone，可以复制 <code>server.go</code> 的代码：</p>

<pre><code class="language-go">package main

import (
	&#34;fmt&#34;
	&#34;log&#34;
	&#34;net/http&#34;
)

func Reverse(s string) string {
	r := []rune(s)
	for i, j := 0, len(r)-1; i &lt; j; i, j = i+1, j-1 {
		r[i], r[j] = r[j], r[i]
	}
	return string(r)
}

func handler(w http.ResponseWriter, r *http.Request) {
	fmt.Fprintf(w, &#34;hi %s&#34;, Reverse(r.URL.Path[1:]))
}

func main() {
	http.HandleFunc(&#34;/&#34;, handler)
	log.Println(&#34;server run in 0.0.0.0:8080&#34;)
	log.Fatal(http.ListenAndServe(&#34;:8080&#34;, nil))
}
</code></pre>

<p>然后新增 <code>Dockerfile</code> 文件，内容如下：</p>

<pre><code class="language-Dockerfile">FROM golang:alpine as builder
ADD . /workspace
WORKDIR /workspace
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o web-server .

FROM scratch
COPY --from=builder /workspace/web-server /web-server
EXPOSE 8080
CMD [&#34;/web-server&#34;]
</code></pre>

<p>上面的 <code>Dockerfile</code> 使用了多阶段构建(Multi Stage)，构建过程分成了 2 个阶段，第 1 阶段使用预装 <code>Go</code> 的 Alpine 镜像编译程序，第 2 阶段使用一个空镜像 <code>scratch</code> ，将第一阶段编译的二进制文件文件 <code>web-server</code> 复制到根目录，定义镜像开放端口并执行。</p>

<p>执行 <code>docker build -t test-web-server .</code> 编译镜像。编译成功后，可通过 <code>docker images</code> 指令查看镜像列表确认。</p>

<p>运行容器测试下结果：</p>

<pre><code class="language-bash">docker run -d --name test-web-server001 -p 8080:8080 test-web-server
docker ps
docker logs test-web-server001
curl 127.0.0.1:8080/docker-and-compos
</code></pre>

<h3 id="完整-dockerfile-指令说明">完整 <code>Dockerfile</code> 指令说明</h3>

<pre><code class="language-Dockerfile"># 指定基础镜像，并添加别名
FROM golang:alpine as builder

# 标识 image 作者
MAINTAINER zzir

# 将当前目录下文件添加到容器 /workspace
ADD . /workspace

# 指定当前工作目录
WORKDIR /workspace

# 执行命令，编译 Go 项目
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o web-server .


# 第二阶段构建 ---------- ---------- ---------- ---------- ----------
FROM alpine

# 添加标签
LABEL version=&#34;1.0&#34; description=&#34;test&#34;

# 定义构建参数，可在构建时通过 --build-arg 改变
ARG key=default_value

# 将上一阶段编译的文件拷贝到当前镜像
COPY --from=builder /workspace/web-server /usr/local/bin/

# 设置环境变量
ENV key value

# 执行命令，添加用户
RUN adduser -S -D -H -h /home/app app

# 指定用户
USER app

# 声明端口
EXPOSE 8080

# 定义挂载点
VOLUME [&#34;/data&#34;]

# ENTRYPOINT 指令存在时，CMD 都是 ENTRYPOINT 的参数
# ENTRYPOINT [&#34;web-server&#34;]

# 指定容器启动时执行的命令
CMD [&#34;web-server&#34;]

# 指定默认 SHELL
SHELL [&#34;/bin/sh&#34;, &#34;-c&#34;]

# 其它镜像以当前镜像为基础镜像时触发 
ONBUILD ADD . /tmp/

# 指定退出的信号值
STOPSIGNAL SIGKILL

# 配置健康检查
HEALTHCHECK --interval=1m --timeout=10s --start-period=10s --retries=3  CMD curl -f http://127.0.0.1:8080/ || exit 1
</code></pre>

<p>由于 alpine 基础镜像默认没有安装 curl，<code>docker ps</code> 查看容器健康检测会显示 <code>unhealthy</code>。解决方法：</p>

<ol>
<li>编译镜像时执行 <code>RUN apk add curl -y</code></li>
<li>将健康检测 <code>CMD</code> 替换为 <code>wget -q -O - 127.0.0.1:8080/asdf</code></li>
</ol>

<h3 id="entrypoint-和-cmd">ENTRYPOINT 和 CMD</h3>

<p><code>ENTRYPOINT</code> 和 <code>CMD</code> 构建阶段都会被忽略，而是在启动时执行。多数情况下它们应该是单独使用的，有一种例外是 <code>CMD</code> 为 <code>ENTRYPOINT</code> 提供默认可选参数，比如：</p>

<pre><code class="language-Dockerfile">...
ENTRYPOINT [&#34;ls&#34;, &#34;/&#34;]
CMD [&#34;-a&#34;, &#34;-l&#34;]
</code></pre>

<p>这种情况下容器启动时执行的是 <code>ls / -a -l</code> 。但也可以启动时覆盖：</p>

<pre><code class="language-bash">docker run --entrypoint /bin/cat &lt;container&gt; -n /etc/passwd
</code></pre>

<p>这样就把默认启动命令 <code>ls / -a -l</code> 替换成了 <code>/bin/cat -n /etc/passwd</code>。</p>

<p>关于 <code>ENTRYPOINT</code> 和 <code>CMD</code> 更具体可以参考官方文档：<a href="https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact" rel="nofollow">https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact</a></p>

<h2>官方仓库操作</h2>

<p>最常用的 <code>PULL</code> 应该很熟悉了，我们尝试把编译的镜像上传到官方镜像仓库。</p>

<p>我们还使用最开始的 <code>Dockerfile</code>：</p>

<pre><code class="language-Dockerfile">FROM golang:alpine as builder
ADD . /workspace
WORKDIR /workspace
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o web-server .

FROM scratch
COPY --from=builder /workspace/web-server /web-server
EXPOSE 8080
CMD [&#34;/web-server&#34;]
</code></pre>

<p>并重新编译镜像：</p>

<pre><code class="language-bash">docker build -t test-web-server .
</code></pre>

<p>登录：</p>

<pre><code class="language-bash">docker login --username=zzir --password=&#39;********&#39;
</code></pre>

<p>为镜像打上标签：</p>

<pre><code class="language-bash">docker tag test-web-server zzir/test-web-server:latest
</code></pre>

<p>上传镜像：</p>

<pre><code class="language-bash">docker push zzir/test-web-server:latest
</code></pre>

<p>默认是公开镜像(注意请勿上传敏感信息到公开镜像)，至此你已经可以在其它地方下载 <code>zzir/test-web-server:latest</code> 啦，这里我使用的是自己的用户名，你需要更换成你自己的，或者重新注册一个。</p>

<p>下载验证：</p>

<pre><code class="language-bash">docker pull zzir/test-web-server
</code></pre>

<p>也可以登录 <a href="https://cloud.docker.com/repository/docker/zzir/test-web-server/" rel="nofollow">https://cloud.docker.com/repository/docker/zzir/test-web-server/</a> 查看。</p>

<h2 id="搭建私有仓库-registry">搭建私有仓库 Registry</h2>

<p>上面我们尝试手动编译镜像并上传到官方公开镜像仓库，但工作中我们可能对镜像仓库需要一些更定制化的需求，官方也给出了私有仓库的搭建方法。</p>

<p>搭建私有仓库非常简单，使用 Docker 启动：</p>

<pre><code class="language-bash">docker run -d -p 5000:5000 --restart=always --name registry -v /data/registry:/var/lib/registry registry
</code></pre>

<p>需要编辑 <code>/etc/docker/daemon.json</code> 配置 Docker 仓库地址：</p>

<p><code>192.168.5.242</code> 是我的远程服务器地址，这里需要换成你的服务器地址。</p>

<pre><code class="language-json">{
    &#34;insecure-registries&#34;:[
      &#34;192.168.5.242:5000&#34;
    ]
}
</code></pre>

<p>给镜像打上标签：</p>

<pre><code class="language-bash">docker pull zzir/test-web-server
docker tag zzir/test-web-server:latest 192.168.5.242:5000/test-web-server:latest
</code></pre>

<p>推送到私有镜像仓库：</p>

<pre><code>docker push 192.168.5.242:5000/test-web-server:latest
</code></pre>

<p>通过 API 确认下：</p>

<pre><code class="language-bash">curl 192.168.5.242:5000/v2/_catalog
</code></pre>

<p>返回 <code>{&#34;repositories&#34;:[test-web-server&#34;]}</code> 说明镜像已经上传成功。</p>

<p>更多 API 可以查看 <a href="https://docs.docker.com/registry/spec/api/" rel="nofollow">https://docs.docker.com/registry/spec/api/</a></p>

<p>删除本地镜像再下载测试：</p>

<pre><code class="language-bash">docker rmi 192.168.5.242:5000/test-web-server
docker pull 192.168.5.242:5000/test-web-server
</code></pre>

<p>没有问题。</p>

<h2 id="私有仓库-registry-web-ui">私有仓库 Registry WEB UI</h2>

<p>如果你不想通过 API 查看私有镜像仓库状态，也可以安装个镜像仓库的 WEB UI。</p>

<p>直接通过 <code>Docker</code> 安装：</p>

<pre><code class="language-bash">docker run -d --name registry-ui -p 5001:80  --link registry -e URL=http://192.168.5.242:5000 -e DELETE_IMAGES=true joxit/docker-registry-ui:static
</code></pre>

<p>浏览器访问 <code>192.168.5.242:5001</code> 发现 <code>CORS</code> 跨域错误，需要配置 <code>registry</code> 容器，为方便我们直接进入容器修改：</p>

<pre><code class="language-bash">docker exec -ti registry /bin/sh
</code></pre>

<p>修改 <code>/etc/docker/registry/config.yml</code> ：</p>

<pre><code>headers:
    X-Content-Type-Options: [nosniff]
    Access-Control-Allow-Origin: [&#39;*&#39;]
    Access-Control-Allow-Methods: [&#39;*&#39;]
    Access-Control-Allow-Headers: [&#39;*&#39;]
    Access-Control-Max-Age: [1728000]
    Access-Control-Allow-Credentials: [true]
    Access-Control-Expose-Headers: [&#39;Docker-Content-Digest&#39;]
</code></pre>

<p>保存并重启 <code>registry</code> 容器，更优雅的做法是将配置文件挂载入 <code>registry</code> 容器。</p>

<p>完整 <code>registry</code> 配置：</p>

<pre><code class="language-yaml">version: 0.1
log:
  fields:
    service: registry
storage:
  cache:
    blobdescriptor: inmemory
  filesystem:
    rootdirectory: /var/lib/registry
http:
  addr: :5000
  headers:
    X-Content-Type-Options: [nosniff]
    Access-Control-Allow-Origin: [&#39;*&#39;]
    Access-Control-Allow-Methods: [&#39;*&#39;]
    Access-Control-Allow-Headers: [&#39;*&#39;]
    Access-Control-Max-Age: [1728000]
    Access-Control-Allow-Credentials: [true]
    Access-Control-Expose-Headers: [&#39;Docker-Content-Digest&#39;]
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3
</code></pre>

<h2>更多</h2>

<ul>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/" rel="nofollow">https://docs.docker.com/develop/develop-images/dockerfile_best-practices/</a></li>
<li><a href="https://docs.docker.com/engine/reference/builder/" rel="nofollow">https://docs.docker.com/engine/reference/builder/</a></li>
<li><a href="https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact" rel="nofollow">https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact</a></li>
<li><a href="https://docs.docker.com/compose/" rel="nofollow">https://docs.docker.com/compose/</a></li>
<li><a href="https://docs.docker.com/registry/" rel="nofollow">https://docs.docker.com/registry/</a></li>
<li><a href="https://github.com/docker/distribution" rel="nofollow">https://github.com/docker/distribution</a></li>
<li><a href="https://docs.docker.com/registry/spec/api/" rel="nofollow">https://docs.docker.com/registry/spec/api/</a></li>
</ul>




            </div>
            <div class="post-info">
                <p class="post-tags">
                    
                        <a href="../tags/docker">Docker</a>
                    
                        <a href="../tags/dockerfile">Dockerfile</a>
                    
                        <a href="../tags/registry">Registry</a>
                    
                </p>
            </div>
        </article>
    </main>



    <footer>
        <p class="post-author">© <a href="/">zzir</a></p>
        <p class="foot-nav"><a href="/archives.html">Archive</a> | <a href="/about.html">About</a></p>
        <p class="beian">
            <span><img alt="zzir" src="/imgs/beian.png">浙公网安备33010902002287号</span>
            <span>浙ICP备19040093号</span>
        </p>
    </footer>



</body>
</html>
