<!DOCTYPE html>
<html lang="zh"><head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="ZZIR">
    <meta name="description" content="FUN~">
    <meta name="keywords" content="zzir,Golang,Python,Docker,K8S">

    <link rel="stylesheet" href="/assets/css/style.css">

    <link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet"type="text/css">
    <link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css">
    <link rel="stylesheet" href="/assets/css/github.css">

    <title>Dockerfile And Registry - ZZIR's Note</title>
</head><body>
<main class="page-content" aria-label="Content">
    <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="post-back" id="post-back" style="display: none">
        <a class="black-link" href="https://zzir.cn">ğŸ™„</a>
    </div>
    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline">
            Dockerfile And Registry
        </h1>
        <p class="post-meta">
            <time class="dt-published" datetime="2019-10-29T00:00:00+08:00" itemprop="datePublished">Oct 29, 2019
            </time></p>
    </header>

    <div class="post-content e-content" itemprop="articleBody">
        <table>
  <thead>
    <tr>
      <th>ç¯å¢ƒ</th>
      <th>ç‰ˆæœ¬</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>æœ¬åœ°ç¯å¢ƒ</td>
      <td>macOS Catalina</td>
    </tr>
    <tr>
      <td>è¿œç¨‹ç¯å¢ƒ</td>
      <td>CentOS Linux release 7.7.1908 (Core)</td>
    </tr>
    <tr>
      <td>Docker Engine</td>
      <td>Community 19.03.2</td>
    </tr>
    <tr>
      <td>Docker Compose</td>
      <td>Version 1.24.1</td>
    </tr>
  </tbody>
</table>

<p>Docker é™¤äº†å¯ä»¥ä»å®˜æ–¹é•œåƒä»“åº“ä¸‹è½½å’Œä¸Šä¼ é•œåƒï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <code class="highlighter-rouge">Dockerfile</code> è‡ªå·±ç¼–è¯‘é•œåƒå’Œä½¿ç”¨ç§æœ‰æˆ–ç¬¬ä¸‰æ–¹é•œåƒä»“åº“ã€‚</p>

<h2 id="dockerfile">Dockerfile</h2>

<p><code class="highlighter-rouge">Dockerfile</code> æ–‡ä»¶ä¸­åŒ…å«ç”¨äºè‡ªåŠ¨æ„å»ºé•œåƒçš„æŒ‡ä»¤ï¼Œæ„å»ºè¿‡ç¨‹ä¸­ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªåªè¯»å±‚ï¼Œæ¯ä¸€å±‚éƒ½æ˜¯ä¸Šä¸€å±‚çš„å¢é‡ï¼Œæœ€åå †å èµ·æ¥ï¼Œæ„æˆäº†é•œåƒã€‚</p>

<h3 id="ç¼–è¯‘-go-å®ç°çš„-http-æœåŠ¡">ç¼–è¯‘ Go å®ç°çš„ HTTP æœåŠ¡ï¼š</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://gist.github.com/d13f96506aebed11af6e6799f71acba4.git
<span class="nb">cd </span>d13f96506aebed11af6e6799f71acba4
vim Dockerfile
</code></pre></div></div>

<p>å¦‚æœæ— æ³• Cloneï¼Œå¯ä»¥å¤åˆ¶ <code class="highlighter-rouge">server.go</code> çš„ä»£ç ï¼š</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"fmt"</span>
	<span class="s">"log"</span>
	<span class="s">"net/http"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">Reverse</span><span class="p">(</span><span class="n">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="n">r</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">rune</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">:=</span> <span class="m">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="m">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="m">1</span> <span class="p">{</span>
		<span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kt">string</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">handler</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s">"hi %s"</span><span class="p">,</span> <span class="n">Reverse</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">Path</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]))</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
	<span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"server run in 0.0.0.0:8080"</span><span class="p">)</span>
	<span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8080"</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç„¶åæ–°å¢ <code class="highlighter-rouge">Dockerfile</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> golang:alpine as builder</span>
<span class="k">ADD</span><span class="s"> . /workspace</span>
<span class="k">WORKDIR</span><span class="s"> /workspace</span>
<span class="k">RUN </span><span class="nv">CGO_ENABLED</span><span class="o">=</span>0 <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build <span class="nt">-o</span> web-server .

<span class="k">FROM</span><span class="s"> scratch</span>
<span class="k">COPY</span><span class="s"> --from=builder /workspace/web-server /web-server</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>
<span class="k">CMD</span><span class="s"> ["/web-server"]</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„ <code class="highlighter-rouge">Dockerfile</code> ä½¿ç”¨äº†å¤šé˜¶æ®µæ„å»º(Multi Stage)ï¼Œæ„å»ºè¿‡ç¨‹åˆ†æˆäº† 2 ä¸ªé˜¶æ®µï¼Œç¬¬ 1 é˜¶æ®µä½¿ç”¨é¢„è£… <code class="highlighter-rouge">Go</code> çš„ Alpine é•œåƒç¼–è¯‘ç¨‹åºï¼Œç¬¬ 2 é˜¶æ®µä½¿ç”¨ä¸€ä¸ªç©ºé•œåƒ <code class="highlighter-rouge">scratch</code> ï¼Œå°†ç¬¬ä¸€é˜¶æ®µç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶æ–‡ä»¶ <code class="highlighter-rouge">web-server</code> å¤åˆ¶åˆ°æ ¹ç›®å½•ï¼Œå®šä¹‰é•œåƒå¼€æ”¾ç«¯å£å¹¶æ‰§è¡Œã€‚</p>

<p>æ‰§è¡Œ <code class="highlighter-rouge">docker build -t test-web-server .</code> ç¼–è¯‘é•œåƒã€‚ç¼–è¯‘æˆåŠŸåï¼Œå¯é€šè¿‡ <code class="highlighter-rouge">docker images</code> æŒ‡ä»¤æŸ¥çœ‹é•œåƒåˆ—è¡¨ç¡®è®¤ã€‚</p>

<p>è¿è¡Œå®¹å™¨æµ‹è¯•ä¸‹ç»“æœï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--name</span> test-web-server001 <span class="nt">-p</span> 8080:8080 test-web-server
docker ps
docker logs test-web-server001
curl 127.0.0.1:8080/docker-and-compos
</code></pre></div></div>

<h3 id="å®Œæ•´-dockerfile-æŒ‡ä»¤è¯´æ˜">å®Œæ•´ <code class="highlighter-rouge">Dockerfile</code> æŒ‡ä»¤è¯´æ˜</h3>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æŒ‡å®šåŸºç¡€é•œåƒï¼Œå¹¶æ·»åŠ åˆ«å</span>
<span class="k">FROM</span><span class="s"> golang:alpine as builder</span>

<span class="c"># æ ‡è¯† image ä½œè€…</span>
<span class="k">MAINTAINER</span><span class="s"> zzir</span>

<span class="c"># å°†å½“å‰ç›®å½•ä¸‹æ–‡ä»¶æ·»åŠ åˆ°å®¹å™¨ /workspace</span>
<span class="k">ADD</span><span class="s"> . /workspace</span>

<span class="c"># æŒ‡å®šå½“å‰å·¥ä½œç›®å½•</span>
<span class="k">WORKDIR</span><span class="s"> /workspace</span>

<span class="c"># æ‰§è¡Œå‘½ä»¤ï¼Œç¼–è¯‘ Go é¡¹ç›®</span>
<span class="k">RUN </span><span class="nv">CGO_ENABLED</span><span class="o">=</span>0 <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build <span class="nt">-o</span> web-server .


<span class="c"># ç¬¬äºŒé˜¶æ®µæ„å»º ---------- ---------- ---------- ---------- ----------</span>
<span class="k">FROM</span><span class="s"> alpine</span>

<span class="c"># æ·»åŠ æ ‡ç­¾</span>
<span class="k">LABEL</span><span class="s"> version="1.0" description="test"</span>

<span class="c"># å®šä¹‰æ„å»ºå‚æ•°ï¼Œå¯åœ¨æ„å»ºæ—¶é€šè¿‡ --build-arg æ”¹å˜</span>
<span class="k">ARG</span><span class="s"> key=default_value</span>

<span class="c"># å°†ä¸Šä¸€é˜¶æ®µç¼–è¯‘çš„æ–‡ä»¶æ‹·è´åˆ°å½“å‰é•œåƒ</span>
<span class="k">COPY</span><span class="s"> --from=builder /workspace/web-server /usr/local/bin/</span>

<span class="c"># è®¾ç½®ç¯å¢ƒå˜é‡</span>
<span class="k">ENV</span><span class="s"> key value</span>

<span class="c"># æ‰§è¡Œå‘½ä»¤ï¼Œæ·»åŠ ç”¨æˆ·</span>
<span class="k">RUN </span>adduser <span class="nt">-S</span> <span class="nt">-D</span> <span class="nt">-H</span> <span class="nt">-h</span> /home/app app

<span class="c"># æŒ‡å®šç”¨æˆ·</span>
<span class="k">USER</span><span class="s"> app</span>

<span class="c"># å£°æ˜ç«¯å£</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>

<span class="c"># å®šä¹‰æŒ‚è½½ç‚¹</span>
<span class="k">VOLUME</span><span class="s"> ["/data"]</span>

<span class="c"># ENTRYPOINT æŒ‡ä»¤å­˜åœ¨æ—¶ï¼ŒCMD éƒ½æ˜¯ ENTRYPOINT çš„å‚æ•°</span>
<span class="c"># ENTRYPOINT ["web-server"]</span>

<span class="c"># æŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤</span>
<span class="k">CMD</span><span class="s"> ["web-server"]</span>

<span class="c"># æŒ‡å®šé»˜è®¤ SHELL</span>
<span class="k">SHELL</span><span class="s"> ["/bin/sh", "-c"]</span>

<span class="c"># å…¶å®ƒé•œåƒä»¥å½“å‰é•œåƒä¸ºåŸºç¡€é•œåƒæ—¶è§¦å‘ </span>
<span class="k">ONBUILD</span><span class="w"> </span><span class="k">ADD</span><span class="s"> . /tmp/</span>

<span class="c"># æŒ‡å®šé€€å‡ºçš„ä¿¡å·å€¼</span>
<span class="k">STOPSIGNAL</span><span class="s"> SIGKILL</span>

<span class="c"># é…ç½®å¥åº·æ£€æŸ¥</span>
<span class="k">HEALTHCHECK</span><span class="s"> --interval=1m --timeout=10s --start-period=10s --retries=3  CMD curl -f http://127.0.0.1:8080/ || exit 1</span>
</code></pre></div></div>

<p>ç”±äº alpine åŸºç¡€é•œåƒé»˜è®¤æ²¡æœ‰å®‰è£… curlï¼Œ<code class="highlighter-rouge">docker ps</code> æŸ¥çœ‹å®¹å™¨å¥åº·æ£€æµ‹ä¼šæ˜¾ç¤º <code class="highlighter-rouge">unhealthy</code>ã€‚è§£å†³æ–¹æ³•ï¼š</p>

<ol>
  <li>ç¼–è¯‘é•œåƒæ—¶æ‰§è¡Œ <code class="highlighter-rouge">RUN apk add curl -y</code></li>
  <li>å°†å¥åº·æ£€æµ‹ <code class="highlighter-rouge">CMD</code> æ›¿æ¢ä¸º <code class="highlighter-rouge">wget -q -O - 127.0.0.1:8080/asdf</code></li>
</ol>

<h3 id="entrypoint-å’Œ-cmd">ENTRYPOINT å’Œ CMD</h3>

<p><code class="highlighter-rouge">ENTRYPOINT</code> å’Œ <code class="highlighter-rouge">CMD</code> æ„å»ºé˜¶æ®µéƒ½ä¼šè¢«å¿½ç•¥ï¼Œè€Œæ˜¯åœ¨å¯åŠ¨æ—¶æ‰§è¡Œã€‚å¤šæ•°æƒ…å†µä¸‹å®ƒä»¬åº”è¯¥æ˜¯å•ç‹¬ä½¿ç”¨çš„ï¼Œæœ‰ä¸€ç§ä¾‹å¤–æ˜¯ <code class="highlighter-rouge">CMD</code> ä¸º <code class="highlighter-rouge">ENTRYPOINT</code> æä¾›é»˜è®¤å¯é€‰å‚æ•°ï¼Œæ¯”å¦‚ï¼š</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="k">ENTRYPOINT</span><span class="s"> ["ls", "/"]</span>
<span class="k">CMD</span><span class="s"> ["-a", "-l"]</span>
</code></pre></div></div>

<p>è¿™ç§æƒ…å†µä¸‹å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„æ˜¯ <code class="highlighter-rouge">ls / -a -l</code> ã€‚ä½†ä¹Ÿå¯ä»¥å¯åŠ¨æ—¶è¦†ç›–ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">--entrypoint</span> /bin/cat &lt;container&gt; <span class="nt">-n</span> /etc/passwd
</code></pre></div></div>

<p>è¿™æ ·å°±æŠŠé»˜è®¤å¯åŠ¨å‘½ä»¤ <code class="highlighter-rouge">ls / -a -l</code> æ›¿æ¢æˆäº† <code class="highlighter-rouge">/bin/cat -n /etc/passwd</code>ã€‚</p>

<p>å…³äº <code class="highlighter-rouge">ENTRYPOINT</code> å’Œ <code class="highlighter-rouge">CMD</code> æ›´å…·ä½“å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact</p>

<h2 id="å®˜æ–¹ä»“åº“æ“ä½œ">å®˜æ–¹ä»“åº“æ“ä½œ</h2>

<p>æœ€å¸¸ç”¨çš„ <code class="highlighter-rouge">PULL</code> åº”è¯¥å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬å°è¯•æŠŠç¼–è¯‘çš„é•œåƒä¸Šä¼ åˆ°å®˜æ–¹é•œåƒä»“åº“ã€‚</p>

<p>æˆ‘ä»¬è¿˜ä½¿ç”¨æœ€å¼€å§‹çš„ <code class="highlighter-rouge">Dockerfile</code>ï¼š</p>

<div class="language-Dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> golang:alpine as builder</span>
<span class="k">ADD</span><span class="s"> . /workspace</span>
<span class="k">WORKDIR</span><span class="s"> /workspace</span>
<span class="k">RUN </span><span class="nv">CGO_ENABLED</span><span class="o">=</span>0 <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build <span class="nt">-o</span> web-server .

<span class="k">FROM</span><span class="s"> scratch</span>
<span class="k">COPY</span><span class="s"> --from=builder /workspace/web-server /web-server</span>
<span class="k">EXPOSE</span><span class="s"> 8080</span>
<span class="k">CMD</span><span class="s"> ["/web-server"]</span>
</code></pre></div></div>

<p>å¹¶é‡æ–°ç¼–è¯‘é•œåƒï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">-t</span> test-web-server <span class="nb">.</span>
</code></pre></div></div>

<p>ç™»å½•ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker login <span class="nt">--username</span><span class="o">=</span>zzir <span class="nt">--password</span><span class="o">=</span><span class="s1">'********'</span>
</code></pre></div></div>

<p>ä¸ºé•œåƒæ‰“ä¸Šæ ‡ç­¾ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker tag test-web-server zzir/test-web-server:latest
</code></pre></div></div>

<p>ä¸Šä¼ é•œåƒï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push zzir/test-web-server:latest
</code></pre></div></div>

<p>é»˜è®¤æ˜¯å…¬å¼€é•œåƒ(æ³¨æ„è¯·å‹¿ä¸Šä¼ æ•æ„Ÿä¿¡æ¯åˆ°å…¬å¼€é•œåƒ)ï¼Œè‡³æ­¤ä½ å·²ç»å¯ä»¥åœ¨å…¶å®ƒåœ°æ–¹ä¸‹è½½ <code class="highlighter-rouge">zzir/test-web-server:latest</code> å•¦ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯è‡ªå·±çš„ç”¨æˆ·åï¼Œä½ éœ€è¦æ›´æ¢æˆä½ è‡ªå·±çš„ï¼Œæˆ–è€…é‡æ–°æ³¨å†Œä¸€ä¸ªã€‚</p>

<p>ä¸‹è½½éªŒè¯ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull zzir/test-web-server
</code></pre></div></div>

<p>ä¹Ÿå¯ä»¥ç™»å½• https://cloud.docker.com/repository/docker/zzir/test-web-server/ æŸ¥çœ‹ã€‚</p>

<h2 id="æ­å»ºç§æœ‰ä»“åº“-registry">æ­å»ºç§æœ‰ä»“åº“ Registry</h2>

<p>ä¸Šé¢æˆ‘ä»¬å°è¯•æ‰‹åŠ¨ç¼–è¯‘é•œåƒå¹¶ä¸Šä¼ åˆ°å®˜æ–¹å…¬å¼€é•œåƒä»“åº“ï¼Œä½†å·¥ä½œä¸­æˆ‘ä»¬å¯èƒ½å¯¹é•œåƒä»“åº“éœ€è¦ä¸€äº›æ›´å®šåˆ¶åŒ–çš„éœ€æ±‚ï¼Œå®˜æ–¹ä¹Ÿç»™å‡ºäº†ç§æœ‰ä»“åº“çš„æ­å»ºæ–¹æ³•ã€‚</p>

<p>æ­å»ºç§æœ‰ä»“åº“éå¸¸ç®€å•ï¼Œä½¿ç”¨ Docker å¯åŠ¨ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">-p</span> 5000:5000 <span class="nt">--restart</span><span class="o">=</span>always <span class="nt">--name</span> registry <span class="nt">-v</span> /data/registry:/var/lib/registry registry
</code></pre></div></div>

<p>éœ€è¦ç¼–è¾‘ <code class="highlighter-rouge">/etc/docker/daemon.json</code> é…ç½® Docker ä»“åº“åœ°å€ï¼š</p>

<p><code class="highlighter-rouge">192.168.5.242</code> æ˜¯æˆ‘çš„è¿œç¨‹æœåŠ¡å™¨åœ°å€ï¼Œè¿™é‡Œéœ€è¦æ¢æˆä½ çš„æœåŠ¡å™¨åœ°å€ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"insecure-registries"</span><span class="p">:[</span><span class="w">
      </span><span class="s2">"192.168.5.242:5000"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>ç»™é•œåƒæ‰“ä¸Šæ ‡ç­¾ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull zzir/test-web-server
docker tag zzir/test-web-server:latest 192.168.5.242:5000/test-web-server:latest
</code></pre></div></div>

<p>æ¨é€åˆ°ç§æœ‰é•œåƒä»“åº“ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push 192.168.5.242:5000/test-web-server:latest
</code></pre></div></div>

<p>é€šè¿‡ API ç¡®è®¤ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl 192.168.5.242:5000/v2/_catalog
</code></pre></div></div>

<p>è¿”å› <code class="highlighter-rouge">{"repositories":[test-web-server"]}</code> è¯´æ˜é•œåƒå·²ç»ä¸Šä¼ æˆåŠŸã€‚</p>

<p>æ›´å¤š API å¯ä»¥æŸ¥çœ‹ https://docs.docker.com/registry/spec/api/</p>

<p>åˆ é™¤æœ¬åœ°é•œåƒå†ä¸‹è½½æµ‹è¯•ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker rmi 192.168.5.242:5000/test-web-server
docker pull 192.168.5.242:5000/test-web-server
</code></pre></div></div>

<p>æ²¡æœ‰é—®é¢˜ã€‚</p>

<h2 id="ç§æœ‰ä»“åº“-registry-web-ui">ç§æœ‰ä»“åº“ Registry WEB UI</h2>

<p>å¦‚æœä½ ä¸æƒ³é€šè¿‡ API æŸ¥çœ‹ç§æœ‰é•œåƒä»“åº“çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥å®‰è£…ä¸ªé•œåƒä»“åº“çš„ WEB UIã€‚</p>

<p>ç›´æ¥é€šè¿‡ <code class="highlighter-rouge">Docker</code> å®‰è£…ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--name</span> registry-ui <span class="nt">-p</span> 5001:80  <span class="nt">--link</span> registry <span class="nt">-e</span> <span class="nv">URL</span><span class="o">=</span>http://192.168.5.242:5000 <span class="nt">-e</span> <span class="nv">DELETE_IMAGES</span><span class="o">=</span><span class="nb">true </span>joxit/docker-registry-ui:static
</code></pre></div></div>

<p>æµè§ˆå™¨è®¿é—® <code class="highlighter-rouge">192.168.5.242:5001</code> å‘ç° <code class="highlighter-rouge">CORS</code> è·¨åŸŸé”™è¯¯ï¼Œéœ€è¦é…ç½® <code class="highlighter-rouge">registry</code> å®¹å™¨ï¼Œä¸ºæ–¹ä¾¿æˆ‘ä»¬ç›´æ¥è¿›å…¥å®¹å™¨ä¿®æ”¹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker <span class="nb">exec</span> <span class="nt">-ti</span> registry /bin/sh
</code></pre></div></div>

<p>ä¿®æ”¹ <code class="highlighter-rouge">/etc/docker/registry/config.yml</code> ï¼š</p>

<pre><code class="language-yamlÂ ">headers:
    X-Content-Type-Options: [nosniff]
    Access-Control-Allow-Origin: ['*']
    Access-Control-Allow-Methods: ['*']
    Access-Control-Allow-Headers: ['*']
    Access-Control-Max-Age: [1728000]
    Access-Control-Allow-Credentials: [true]
    Access-Control-Expose-Headers: ['Docker-Content-Digest']
</code></pre>

<p>ä¿å­˜å¹¶é‡å¯ <code class="highlighter-rouge">registry</code> å®¹å™¨ï¼Œæ›´ä¼˜é›…çš„åšæ³•æ˜¯å°†é…ç½®æ–‡ä»¶æŒ‚è½½å…¥ <code class="highlighter-rouge">registry</code> å®¹å™¨ã€‚</p>

<p>å®Œæ•´ <code class="highlighter-rouge">registry</code> é…ç½®ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="m">0.1</span>
<span class="na">log</span><span class="pi">:</span>
  <span class="na">fields</span><span class="pi">:</span>
    <span class="na">service</span><span class="pi">:</span> <span class="s">registry</span>
<span class="na">storage</span><span class="pi">:</span>
  <span class="na">cache</span><span class="pi">:</span>
    <span class="na">blobdescriptor</span><span class="pi">:</span> <span class="s">inmemory</span>
  <span class="na">filesystem</span><span class="pi">:</span>
    <span class="na">rootdirectory</span><span class="pi">:</span> <span class="s">/var/lib/registry</span>
<span class="na">http</span><span class="pi">:</span>
  <span class="na">addr</span><span class="pi">:</span> <span class="s">:5000</span>
  <span class="na">headers</span><span class="pi">:</span>
    <span class="na">X-Content-Type-Options</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">nosniff</span><span class="pi">]</span>
    <span class="na">Access-Control-Allow-Origin</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">*'</span><span class="pi">]</span>
    <span class="na">Access-Control-Allow-Methods</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">*'</span><span class="pi">]</span>
    <span class="na">Access-Control-Allow-Headers</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">*'</span><span class="pi">]</span>
    <span class="na">Access-Control-Max-Age</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">1728000</span><span class="pi">]</span>
    <span class="na">Access-Control-Allow-Credentials</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">true</span><span class="pi">]</span>
    <span class="na">Access-Control-Expose-Headers</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">Docker-Content-Digest'</span><span class="pi">]</span>
<span class="na">health</span><span class="pi">:</span>
  <span class="na">storagedriver</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">interval</span><span class="pi">:</span> <span class="s">10s</span>
    <span class="na">threshold</span><span class="pi">:</span> <span class="m">3</span>
</code></pre></div></div>

<h2 id="æ›´å¤š">æ›´å¤š</h2>

<ul>
  <li>https://docs.docker.com/develop/develop-images/dockerfile_best-practices/</li>
  <li>https://docs.docker.com/engine/reference/builder/</li>
  <li>https://docs.docker.com/engine/reference/builder/#understand-how-cmd-and-entrypoint-interact</li>
  <li>https://docs.docker.com/compose/</li>
  <li>https://docs.docker.com/registry/</li>
  <li>https://github.com/docker/distribution</li>
  <li>https://docs.docker.com/registry/spec/api/</li>
</ul>

    </div>

    <a class="u-url" href="/2019/dockerfile-and-registry.html" hidden></a>
</article>

<div class="post-tags">
    
    <a>Docker</a>
    
    <a>Dockerfile</a>
    
    <a>Registry</a>
    
</div>

<div class="pagination">
    <ul>
        
        <li class="prev">
            <a href="/2019/docker-quick-handbook.html" title="PREV: Docker å¸¸ç”¨æ“ä½œ">
                â€¹ Docker å¸¸ç”¨æ“ä½œ
            </a>
        </li>
        
        
        <li class="next">
            <a href="/2020/go-linked-list.html" title="NEXT: å•é“¾è¡¨ã€åŒé“¾è¡¨çš„ Golang å®ç°">
                â€º å•é“¾è¡¨ã€åŒé“¾è¡¨çš„ Golang å®ç°
            </a>
        </li>
        
    </ul>
</div>


<div class="giscus"></div>
<script src="https://giscus.app/client.js"
        data-repo="zzir/blog"
        data-repo-id="MDEwOlJlcG9zaXRvcnkyMTk2NjgyOTM="
        data-mapping="title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="light"
        crossorigin="anonymous"
        async>
</script>
    </div>
</main><footer>
    <p class="post-author"><a href="/">ZZIR</a></p>
</footer>
<script defer src="/assets/js/katex/katex.min.js" type="text/javascript"></script>
<script defer src="/assets/js/katex/auto-render.min.js" type="text/javascript"></script>
<script src="/assets/js/zooming.min.js" type="text/javascript"></script>
<script src="/assets/js/highlight.pack.js" type="text/javascript"></script>
<script>
    // zooming
    const zooming = new Zooming({
        customSize: '100%',
    });
    zooming.listen('.paragraph img');
    zooming.listen('.content img');
    zooming.listen('.post-content img');

    // highlight
    hljs.initHighlightingOnLoad();

    // katex
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false},
                {left: "\\(", right: "\\)", display: false},
                {left: "\\[", right: "\\]", display: true}
            ]
        });
    });

    // back display
    function getScrollTop() {
        var scrollTop = 0;
        if (document.documentElement && document.documentElement.scrollTop) {
            scrollTop = document.documentElement.scrollTop;
        } else if (document.body) {
            scrollTop = document.body.scrollTop;
        }
        return scrollTop;
    }

    window.onscroll = function () {
        if (getScrollTop() === 0) {
            document.getElementById("post-back").style.display = "block";
        }
    }
</script>


<script>
    // google analytics
    window.ga = window.ga || function () {
        (ga.q = ga.q || []).push(arguments)
    };
    ga.l = +new Date;
    ga('create', 'UA-121779014-1', 'auto');
    ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>