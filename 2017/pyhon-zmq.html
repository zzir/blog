<!DOCTYPE html>
<html lang="zh"><head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="zzir">
    <meta name="description" content="The architect of civilization.">
    <meta name="keywords" content="zzir,Golang,Python,Docker,K8S">

    <link rel="stylesheet" href="/assets/css/style.css">

    <link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet"
          type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Caveat&display=swap" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css">
    <link rel="stylesheet" href="/assets/css/github.css">

    <title>Python ZMQ - ZZIR's Blog</title>
</head><body>
<main class="page-content" aria-label="Content">
    <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="post-back" id="post-back" style="display: none">
        <a class="black-link" href="https://zzir.cn">ğŸ™„</a>
    </div>
    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline">
            Python ZMQ
        </h1>
        <p class="post-meta">
            <time class="dt-published" datetime="2017-08-31T00:00:00+08:00" itemprop="datePublished">Aug 31, 2017
            </time></p>
    </header>

    <div class="post-content e-content" itemprop="articleBody">
        <h2 id="zmq-allowed-patterns">ZMQ Allowed Patterns</h2>

<ul>
  <li>PUB and SUB</li>
  <li>REQ and REP</li>
  <li>REQ and ROUTER</li>
  <li>DEALER and REP</li>
  <li>DEALER and ROUTER</li>
  <li>DEALER and DEALER</li>
  <li>ROUTER and ROUTER</li>
  <li>PUSH and PULL</li>
  <li>PAIR and PAIR</li>
</ul>

<h2 id="zmqæ¨¡å¼">ZMQæ¨¡å¼</h2>

<h3 id="req-rep">REQ-REP</h3>

<p><img src="/imgs/201708-fig2.png" alt="" /></p>

<p>è¯·æ±‚-åº”ç­”ï¼šç”±è¯·æ±‚ç«¯å‘èµ·è¯·æ±‚ï¼Œå¹¶ç­‰å¾…å›åº”ç«¯å›åº”è¯·æ±‚ã€‚ä»è¯·æ±‚ç«¯æ¥çœ‹ï¼Œä¸€å®šæ˜¯ä¸€å¯¹å¯¹æ”¶å‘é…å¯¹çš„ï¼›åä¹‹ï¼Œåœ¨å›åº”ç«¯ä¸€å®šæ˜¯å‘æ”¶å¯¹ã€‚è¯·æ±‚ç«¯å’Œå›åº”ç«¯éƒ½å¯ä»¥æ˜¯1ï¼šNçš„æ¨¡å‹ã€‚é€šå¸¸æŠŠ1è®¤ä¸ºæ˜¯serverï¼ŒNè®¤ä¸ºæ˜¯Clientã€‚</p>

<p>æ³¨æ„ï¼š</p>

<ol>
  <li>å¿…é¡»å…ˆæé—®ï¼Œåå›ç­”</li>
  <li>å¯¹äºä¸€ä¸ªæé—®ï¼Œåªèƒ½å›ç­”ä¸€æ¬¡</li>
  <li>åœ¨æ²¡æœ‰æ”¶åˆ°å›ç­”å‰ä¸èƒ½å†æ¬¡æé—®</li>
</ol>

<!--more-->

<p><strong>ä¸¾ä¸ªæ —å­</strong></p>

<p>Request:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'tcp://127.0.0.1:10000'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">b</span><span class="s">'hello, i am msg-</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">_</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Received reply </span><span class="si">%</span><span class="s">d [</span><span class="si">%</span><span class="s">s]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>

</code></pre></div></div>

<p>Reply:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import zmq
import time

context = zmq.Context()
socket = content.socket(zmq.REP)
socket.bind('tcp://127.0.0.1:10000')

while True:
    message = socket.recv()
    print("Received request: %s " % message)
    time.sleep(1)
    socket.send("yay, it's ok.")
</code></pre></div></div>

<h4 id="extended-request-reply">Extended Request-Reply</h4>

<p>å…³äº DEALER å’Œ ROUTEï¼š</p>

<p><img src="/imgs/201708-fig27.png" alt="" /></p>

<p>DEALER ç±»ä¼¼ä¸€ä¸ªå¼‚æ­¥çš„ REQ Socketã€‚</p>

<p>ROUTE ç±»ä¼¼ä¸€ä¸ªä¸€éƒ¨çš„ REP Socketã€‚</p>

<p>ä½ ä¾ç„¶å¯ä»¥ä½¿ç”¨REQï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨DEALERï¼Œå®ƒä»¬æœ‰ä¸¤ä¸ªä¸åŒï¼š</p>

<ul>
  <li>The REQ socket always sends an empty delimiter frame before any data frames; the DEALER does not.</li>
  <li>The REQ socket will send only one message before it receives a reply; the DEALER is fully asynchronous.</li>
</ul>

<p>çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼š</p>

<p><img src="/imgs/201708-fig16.png" alt="" /></p>

<p>Broker:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

<span class="n">frontend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>
<span class="n">frontend</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">'tcp://127.0.0.1:5559'</span><span class="p">)</span>

<span class="n">backend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>
<span class="n">backend</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">'tcp://127.0.0.1:5560'</span><span class="p">)</span>

<span class="c1"># init poll set
</span><span class="n">poller</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Poller</span><span class="p">()</span>
<span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">frontend</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>
<span class="n">poller</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">socks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">poller</span><span class="o">.</span><span class="n">poll</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">socks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">frontend</span><span class="p">)</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">frontend</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">socks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">backend</span><span class="p">)</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">POLLIN</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
        <span class="n">frontend</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div></div>

<p>Client:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="c1">#  Prepare our context and sockets
</span><span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:5559"</span><span class="p">)</span>

<span class="c1">#  Do 10 requests, waiting each time for a response
</span><span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">):</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">b</span><span class="s">"Hello"</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Received reply </span><span class="si">%</span><span class="s">s [</span><span class="si">%</span><span class="s">s]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>

</code></pre></div></div>

<p>Server:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:5560"</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Received request: </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">b</span><span class="s">"World"</span><span class="p">)</span>

</code></pre></div></div>

<p>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸å¯¹é€æ˜ï¼Œå”¯ä¸€çš„é™æ€èŠ‚ç‚¹ä»£ç†åœ¨ä¸­é—´ã€‚</p>

<h3 id="pub-sub">PUB-SUB</h3>

<p><img src="/imgs/201708-fig4.png" alt="" /></p>

<p>å‘å¸ƒ-è®¢é˜…ï¼šç±»ä¼¼å¹¿æ’­ã€‚è¿™ä¸ªæ¨¡å‹é‡Œï¼Œå‘å¸ƒç«¯æ˜¯å•å‘åªå‘é€æ•°æ®çš„ï¼Œä¸”ä¸å…³å¿ƒæ˜¯å¦æŠŠå…¨éƒ¨çš„ä¿¡æ¯éƒ½å‘é€ç»™è®¢é˜…è€…ã€‚å¦‚æœå‘å¸ƒç«¯å¼€å§‹å‘å¸ƒä¿¡æ¯çš„æ—¶å€™ï¼Œè®¢é˜…ç«¯å°šæœªè¿æ¥ä¸Šï¼Œè¿™äº›ä¿¡æ¯ç›´æ¥ä¸¢å¼ƒã€‚ä¸è¿‡ä¸€æ—¦è®¢é˜…è¿æ¥ä¸Šæ¥ï¼Œä¸­é—´ä¼šä¿è¯æ²¡æœ‰ä¿¡æ¯ä¸¢å¤±ã€‚åŒæ ·ï¼Œè®¢é˜…ç«¯åˆ™åªè´Ÿè´£æ¥æ”¶ï¼Œè€Œä¸èƒ½åé¦ˆã€‚å¦‚æœå‘å¸ƒç«¯å’Œè®¢é˜…ç«¯éœ€è¦äº¤äº’ï¼ˆæ¯”å¦‚è¦ç¡®è®¤è®¢é˜…è€…æ˜¯å¦å·²ç»è¿æ¥ä¸Šï¼‰ï¼Œåˆ™ä½¿ç”¨é¢å¤–çš„socketé‡‡ç”¨è¯·æ±‚å›åº”æ¨¡å‹æ»¡è¶³è¿™ä¸ªéœ€æ±‚ã€‚</p>

<p>ä¸¾ä¸ªæ —å­ï¼š</p>

<p>Publisher</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">port</span> <span class="o">=</span> <span class="s">"10001"</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">topic</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">9999</span><span class="p">,</span> <span class="mi">10005</span><span class="p">)</span>
    <span class="n">messagedata</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">215</span><span class="p">)</span> <span class="o">-</span> <span class="mi">80</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">d"</span> <span class="o">%</span> <span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">messagedata</span><span class="p">))</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">d"</span> <span class="o">%</span> <span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">messagedata</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>Subscriber:</p>

<p>Publisheråƒå¹¿æ’­ä¸€æ ·ä¸€ç›´åœ¨å‘é€ï¼Œä¸ç®¡Subscriberæ˜¯å¦æ¥æ”¶å¾—åˆ°ï¼Œå½“Subscriberè¿æ¥ä¸ŠPublisherä¹‹åï¼Œä»è¿ä¸Šé‚£ä¸€åˆ»å¼€å§‹æ¥æ”¶KEYä¸º10001çš„å†…å®¹ï¼Œæ»¡5æ¬¡è‡ªåŠ¨æ–­å¼€ã€‚Publisherä¾ç„¶ä¼šå‘ç«¯å£å¹¿æ’­æ¶ˆæ¯ï¼Œä¸è®ºSubscriberæ˜¯å¦è¿æ¥ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="c1"># Socket to talk to server
</span><span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Collecting updates from weather server..."</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:10001"</span><span class="p">)</span>

<span class="c1"># Subscribe to zipcode, default is NYC, 10001, not port
</span><span class="n">topicfilter</span> <span class="o">=</span> <span class="s">"10001"</span>
<span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="n">topicfilter</span><span class="p">)</span>

<span class="c1"># Process 5 updates
</span><span class="n">total_value</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">update_nbr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="n">topic</span><span class="p">,</span> <span class="n">messagedata</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">total_value</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">messagedata</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'topic: </span><span class="si">%</span><span class="s">s  messagedata: </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">messagedata</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span>
    <span class="s">"Average value: topic '</span><span class="si">%</span><span class="s">s' messagedata </span><span class="si">%</span><span class="s">dF"</span> <span class="o">%</span>
    <span class="p">(</span><span class="n">topicfilter</span><span class="p">,</span> <span class="n">total_value</span> <span class="o">/</span> <span class="n">update_nbr</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<h3 id="push-pull">PUSH-PULL</h3>

<p><img src="/imgs/201708-fig5.png" alt="" /></p>

<p>ç®¡é“æ¨¡å¼ã€‚è¿™ä¸ªæ¨¡å‹é‡Œï¼Œç®¡é“æ˜¯å•å‘çš„ï¼Œä»PUSHç«¯å•å‘çš„å‘PULLç«¯å•å‘çš„æ¨é€æ•°æ®æµã€‚</p>

<p>ä¸¾ä¸ªæ —å­ï¼š</p>

<p>Ventilator:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

<span class="n">ventilator</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUSH</span><span class="p">)</span>
<span class="n">ventilator</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:5557"</span><span class="p">)</span>

<span class="c1"># random.seed()
</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">workload</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">ventilator</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">workload</span><span class="p">))</span>
</code></pre></div></div>

<p>Worker:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

<span class="n">ventilator</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PULL</span><span class="p">)</span>
<span class="n">ventilator</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'tcp://127.0.0.1:5557'</span><span class="p">)</span>

<span class="n">sink</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUSH</span><span class="p">)</span>
<span class="n">sink</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'tcp://127.0.0.1:5558'</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="c1"># do something
</span>    <span class="n">recv</span> <span class="o">=</span> <span class="n">ventilator</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="n">sink</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">recv</span><span class="p">)</span>
</code></pre></div></div>

<p>Sink:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

<span class="n">sink</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PULL</span><span class="p">)</span>
<span class="n">sink</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:5558"</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">sink</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="pair">PAIR</h3>

<p><img src="/imgs/201708-pair.png" alt="" /></p>

<p>åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œç”¨äºä¸¤ä¸ªçº¿ç¨‹é—´çš„é€šä¿¡ã€‚</p>

<p>Conventional sockets allow:</p>

<ul>
  <li>only strict one-to-one (two peers)</li>
  <li>many-to-one (many clients, one server)</li>
  <li>one-to-many (multicast) relationships</li>
</ul>

<p><strong>Exclusive pair pattern</strong></p>

<p>Paired sockets are very similar to regular sockets.</p>

<ul>
  <li>The communication is bidirectional.</li>
  <li>There is no specific state stored within the socket</li>
  <li>There can only be one connected peer.</li>
  <li>The server listens on a certain port and a client connects to it.</li>
</ul>

<p>ä¸¾ä¸ªæ —å­ï¼š</p>

<p>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¯ä»¥å‘é€ä»»æ„çš„æ¶ˆæ¯æ•°é‡ã€‚</p>

<p>Server:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">port</span> <span class="o">=</span> <span class="s">"5556"</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PAIR</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">"tcp://*:</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"Server message to client3"</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">msg</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>Client:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">port</span> <span class="o">=</span> <span class="s">"5556"</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PAIR</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"tcp://localhost:</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">msg</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"client message to server1"</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"client message to server2"</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="è·¯ç”±">è·¯ç”±</h2>

<p>æ›´å¤æ‚çš„ç½‘ç»œæ¨¡å‹ã€‚ZMQå¯ä»¥å¾ˆå¥½çš„æ”¯æŒè·¯ç”±åŠŸèƒ½ï¼ˆå®ç°è·¯ç”±åŠŸèƒ½çš„ç»„ä»¶å«åšDeviceï¼‰ï¼ŒæŠŠ1ï¼šNæ‰©å±•ä¸ºNï¼šMï¼ˆåªéœ€è¦åŠ å…¥è‹¥å¹²è·¯ç”±èŠ‚ç‚¹ï¼‰ã€‚ä»è¿™ä¸ªæ¨¡å‹çœ‹ï¼Œæ›´åº•å±‚çš„ç«¯ç‚¹åœ°å€æ˜¯å¯¹ä¸Šå±‚éšè—çš„ã€‚æ¯ä¸ªè¯·æ±‚éƒ½éšå«å›åº”åœ°å€ï¼Œè€Œåº”ç”¨åˆ™ä¸å…³å¿ƒå®ƒã€‚</p>

<p>Device ç»„ä»¶æœ‰ 3 ä¸ªåŸºæœ¬æ¨¡å¼ï¼š</p>

<ul>
  <li>Queue</li>
  <li>Forwarder</li>
  <li>Streamer</li>
</ul>

<p>è¿˜æœ‰æ–°çš„Proxy()ã€‚</p>

<h3 id="queue-device">Queue Device</h3>

<p><img src="/imgs/201708-Queue.png" alt="" /></p>

<p>Queue æ˜¯ä½äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸­ä»‹ï¼Œå°†å®¢æˆ·ç«¯çš„è¯·æ±‚è½¬å‘ç»™æœåŠ¡ç«¯ï¼Œå†å°†æ”¶åˆ°çš„æœåŠ¡ç«¯çš„å›åº”è½¬å‘ç»™å®¢æˆ·ç«¯ã€‚</p>

<p>Queue:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">frontend</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">XREP</span><span class="p">)</span>
        <span class="n">frontend</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">'tcp://*:5559'</span><span class="p">)</span>

        <span class="n">backend</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">XREQ</span><span class="p">)</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">'tcp://*:5560'</span><span class="p">)</span>

        <span class="n">zmq</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">QUEUE</span><span class="p">,</span> <span class="n">frontend</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>
        <span class="k">print</span> <span class="s">"bringing down zmq device"</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="n">frontend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">content</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>Client:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">port</span> <span class="o">=</span> <span class="s">'5559'</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

<span class="k">print</span> <span class="s">'Connecting to server...'</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REQ</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'tcp://localhost:</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>

<span class="n">client_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10005</span><span class="p">)</span>

<span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">'Sending request '</span><span class="p">,</span> <span class="n">request</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">'Hello from </span><span class="si">%</span><span class="s">s '</span> <span class="o">%</span> <span class="n">client_id</span><span class="p">)</span>

    <span class="n">message</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">'Received reply </span><span class="si">%</span><span class="s">d [</span><span class="si">%</span><span class="s">s]'</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</code></pre></div></div>

<p>Server:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">port</span> <span class="o">=</span> <span class="s">'5560'</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">REP</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">'tcp://localhost:</span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>

<span class="n">server_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10005</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">'Received request: '</span><span class="p">,</span> <span class="n">message</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">'World from server </span><span class="si">%</span><span class="s">s'</span> <span class="o">%</span> <span class="n">server_id</span><span class="p">)</span>
</code></pre></div></div>

<p>å¦‚æœæƒ³æŸ¥çœ‹è´Ÿè½½å‡è¡¡æ•ˆæœï¼Œå¯ä»¥è¿è¡Œå¤šä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ã€‚å®¢æˆ·ç«¯çš„è¯·æ±‚ä¼šç»ç”±ä¸­ä»‹åˆ†é…åˆ°ä¸åŒçš„æœåŠ¡å™¨ã€‚</p>

<h3 id="forwarder">Forwarder</h3>

<p><img src="/imgs/201708-forwarder.png" alt="" /></p>

<p>å¦‚åŒ QUEUE çš„Â request-reply æ¨¡å¼ã€‚FORWARDER åƒ pub-sub çš„ä»£ç†æœåŠ¡å™¨ã€‚å®ƒå…è®¸ publishers å’Œ subscribers ç§»åŠ¨éƒ¨ä»¶ï¼ŒFORWARDER æ˜¯ä¸­å¿ƒéƒ¨ä»¶è´Ÿè´£è¿æ¥æ‰€æœ‰çš„publisherså’Œsubscribersã€‚</p>

<p>Forwarder:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># sub
</span>        <span class="n">frontend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
        <span class="n">frontend</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:5559"</span><span class="p">)</span>

        <span class="n">frontend</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>

        <span class="c1"># pub
</span>        <span class="n">backend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:5560"</span><span class="p">)</span>

        <span class="c1"># forwarder
</span>        <span class="n">zmq</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">FORWARDER</span><span class="p">,</span> <span class="n">frontend</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>
        <span class="k">print</span> <span class="s">"bringing down zmq device"</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="n">frontend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">context</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>Client:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="n">port</span> <span class="o">=</span> <span class="s">"5560"</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"Collecting updates from server..."</span>
<span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"tcp://localhost:</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>

<span class="n">topicfilter</span> <span class="o">=</span> <span class="s">"9"</span>
<span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUBSCRIBE</span><span class="p">,</span> <span class="n">topicfilter</span><span class="p">)</span>

<span class="k">for</span> <span class="n">update_nbr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">string</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
    <span class="n">topic</span><span class="p">,</span> <span class="n">messagedata</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">topic</span><span class="p">,</span> <span class="n">messagedata</span>
</code></pre></div></div>

<p>Server:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">port</span> <span class="o">=</span> <span class="s">"5559"</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
<span class="n">socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span>
<span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"tcp://localhost:</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">port</span><span class="p">)</span>

<span class="n">publisher_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">topic</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">messagedata</span> <span class="o">=</span> <span class="s">"server#</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">publisher_id</span>
    <span class="k">print</span> <span class="s">"</span><span class="si">%</span><span class="s">s </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">messagedata</span><span class="p">)</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">messagedata</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="streamer">Streamer</h3>

<p><img src="/imgs/201708-streamer.png" alt="" /></p>

<p>Streamer ç”¨äºå¹¶è¡Œç®¡é“æ¶ˆæ¯é€šä¿¡ã€‚ä½œä¸ºä¸€ä¸ªä»£ç†ï¼Œä»PUSHç«¯æ”¶é›†ä»»åŠ¡å¹¶å‘æ”¾ç»™PULLç«¯ã€‚</p>

<p>Streamer:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

        <span class="c1"># pull
</span>        <span class="n">frontend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PULL</span><span class="p">)</span>
        <span class="n">frontend</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">'tcp://127.0.0.1:5559'</span><span class="p">)</span>

        <span class="c1"># push
</span>        <span class="n">backend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUSH</span><span class="p">)</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">'tcp://127.0.0.1:5560'</span><span class="p">)</span>

        <span class="c1"># streamer
</span>        <span class="n">zmq</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">STREAMER</span><span class="p">,</span> <span class="n">frontend</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">e</span>
        <span class="k">print</span> <span class="s">'streamer_device'</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="n">frontend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">backend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">context</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>PUSH:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">zmq</span>

<span class="k">def</span> <span class="nf">producer</span><span class="p">():</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
    <span class="n">zmq_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUSH</span><span class="p">)</span>
    <span class="n">zmq_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:5559"</span><span class="p">)</span>
    <span class="c1"># push
</span>    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">20000</span><span class="p">):</span>
        <span class="n">work_message</span> <span class="o">=</span> <span class="p">{</span><span class="s">'num'</span><span class="p">:</span> <span class="n">num</span><span class="p">}</span>
        <span class="n">zmq_socket</span><span class="o">.</span><span class="n">send_json</span><span class="p">(</span><span class="n">work_message</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">producer</span><span class="p">()</span>
</code></pre></div></div>

<p>PULL:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">consumer</span><span class="p">():</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
    <span class="c1"># pull
</span>    <span class="n">consumer_receiver</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PULL</span><span class="p">)</span>
    <span class="n">consumer_receiver</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:5560"</span><span class="p">)</span>

    <span class="n">consumer_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10005</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">"I am consumer #</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">consumer_id</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">consumer_receiver</span><span class="o">.</span><span class="n">recv_json</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">work</span><span class="p">[</span><span class="s">'num'</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s">'consumer'</span><span class="p">:</span> <span class="n">consumer_id</span><span class="p">,</span> <span class="s">'num'</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
        <span class="k">print</span> <span class="n">result</span>

<span class="n">consumer</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="proxy">Proxy()</h3>

<p>ç”¨äºæ›¿ä»£Deviceã€‚</p>

<p>Show me The Code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">zmq</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

    <span class="c1"># Socket facing clients
</span>    <span class="n">frontend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>
    <span class="n">frontend</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:5559"</span><span class="p">)</span>

    <span class="c1"># Socket facing services
</span>    <span class="n">backend</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>
    <span class="n">backend</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">"tcp://127.0.0.1:5560"</span><span class="p">)</span>

    <span class="n">zmq</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="n">frontend</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>

    <span class="c1"># We never get here
</span>    <span class="n">frontend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">backend</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">context</span><span class="o">.</span><span class="n">term</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<p>å‚è€ƒé“¾æ¥ï¼š  <br />
http://zguide.zeromq.org/py:all  <br />
http://pyzmq.readthedocs.io/en/latest/api/  <br />
https://learning-0mq-with-pyzmq.readthedocs.io/en/latest/pyzmq/  <br />
https://pyzmq.readthedocs.io/en/latest/api/index.html</p>


    </div>

    <a class="u-url" href="/2017/pyhon-zmq.html" hidden></a>
</article>

<div class="post-tags">
    
    <a>ZMQ</a>
    
    <a>Python</a>
    
</div>

<div class="pagination">
    <ul>
        
        <li class="prev">
            <a href="/2017/bitcoin-segwit.html" title="PREV: Bitcoin SegWit(Segregated Witness)">
                â€¹ Bitcoin SegWit(Segregated Witness)
            </a>
        </li>
        
        
        <li class="next">
            <a href="/2017/google-authentication.html" title="NEXT: Google Authentication (2FA)">
                â€º Google Authentication (2FA)
            </a>
        </li>
        
    </ul>
</div>
    </div>
</main><footer>
    <p class="post-author">Â© <a href="/">zzir</a></p>
    <p class="beian">
        
        <span>
            <img src="/assets/imgs/beian.png">
            <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010902002287">æµ™å…¬ç½‘å®‰å¤‡33010902002287å·</a>
        </span>
        ãƒ»ï¸
        <span><a href="http://beian.miit.gov.cn/">æµ™ICPå¤‡19040093å·</a></span>
        
    </p>
</footer>
<script defer src="/assets/js/katex/katex.min.js" type="text/javascript"></script>
<script defer src="/assets/js/katex/auto-render.min.js" type="text/javascript"></script>
<script src="/assets/js/zooming.min.js" type="text/javascript"></script>
<script src="/assets/js/highlight.pack.js" type="text/javascript"></script>
<script>
    // zooming
    const zooming = new Zooming({
        customSize: '100%',
    });
    zooming.listen('.paragraph img');
    // highlight
    hljs.initHighlightingOnLoad();
    // katex
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false},
                {left: "\\(", right: "\\)", display: false},
                {left: "\\[", right: "\\]", display: true}
            ]
        });
    });
</script>


<script>
    // analytics
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?fa1df30338e49443514335c65bd9b8d6";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();

    // back display
    function getScrollTop() {
        var scrollTop = 0;
        if (document.documentElement && document.documentElement.scrollTop) {
            scrollTop = document.documentElement.scrollTop;
        } else if (document.body) {
            scrollTop = document.body.scrollTop;
        }
        return scrollTop;
    }

    window.onscroll = function () {
        if (getScrollTop() === 0) {
            document.getElementById("post-back").style.display = "block";
        }
    }
</script>

</body>
</html>