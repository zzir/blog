<!DOCTYPE html>
<html lang="zh"><head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="ZZIR">
    <meta name="description" content="just for fun">
    <meta name="keywords" content="zzir,Golang,Python,Docker,K8S">

    <link rel="stylesheet" href="/assets/css/style.css">

    <link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet"type="text/css">
    <link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css">
    <link rel="stylesheet" href="/assets/css/github.css">

    <title>Google Authentication (2FA) - ZZIR's Note</title>
</head><body>
<main class="page-content" aria-label="Content">
    <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="post-back" id="post-back" style="display: none">
        <a class="black-link" href="https://zzir.cn">ğŸ™„</a>
    </div>
    <header class="post-header">
        <h1 class="post-title p-name" itemprop="name headline">
            Google Authentication (2FA)
        </h1>
        <p class="post-meta">
            <time class="dt-published" datetime="2017-09-14T00:00:00+08:00" itemprop="datePublished">Sep 14, 2017
            </time></p>
    </header>

    <div class="post-content e-content" itemprop="articleBody">
        <p><a href="https://daplie.github.io/browser-authenticator/">åœ¨çº¿æ¼”ç¤º</a></p>

<p><a href="https://github.com/google/google-authenticator">Google Authentication</a> æ”¯æŒ <a href="http://en.wikipedia.org/wiki/HMAC-based_One-time_Password_Algorithm">HOTP</a> å’Œ <a href="http://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm">TOTP</a> ç®—æ³•ç”ŸæˆäºŒæ¬¡éªŒè¯(2FA. two-factor authentication)å¯†ç ã€‚</p>

<h2 id="hotphmac-base-one-time-passowrd">HOTP(HMAC-base One-Time Passowrd)</h2>

<p>HMACå°±æ˜¯ Hash-based Message Authentication Code çš„æ„æ€ã€‚</p>

<p>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº‹å…ˆåå•†å¥½ä¸€ä¸ªå¯†é’¥ï¼Œç”¨äºä¸€æ¬¡æ€§å¯†ç çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œæ­¤å¯†é’¥ä¸è¢«ä»»ä½•ç¬¬ä¸‰æ–¹æ‰€çŸ¥é“ã€‚</p>

<p>æ­¤å¤–ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å„æœ‰ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå¹¶ä¸”äº‹å…ˆå°†è®¡æ•°å€¼åŒæ­¥ã€‚è®¡ç®—å®Œæˆä¹‹åå®¢æˆ·ç«¯è®¡æ•°å™¨è®¡æ•°å€¼åŠ 1ã€‚</p>

<p>ç”¨æˆ·å°†è¿™ä¸€ç»„åè¿›åˆ¶æ•°è¾“å…¥å¹¶ä¸”æäº¤ä¹‹åï¼ŒæœåŠ¡å™¨ç«¯åŒæ ·çš„è®¡ç®—ï¼Œå¹¶ä¸”ä¸ç”¨æˆ·æäº¤çš„æ•°å€¼æ¯”è¾ƒï¼Œå¦‚æœç›¸åŒï¼Œåˆ™éªŒè¯é€šè¿‡ï¼ŒæœåŠ¡å™¨ç«¯å°†è®¡æ•°å€¼å¢åŠ 1ã€‚å¦‚æœä¸ç›¸åŒï¼Œåˆ™éªŒè¯å¤±è´¥ã€‚</p>

<h2 id="totptime-base-one-time-password">TOTP(Time-base One-Time Password)</h2>

<p>ç†è§£äº†ä¸Šé¢çš„HOTPï¼Œé‚£TOTPåªæ˜¯å°†æ—¶é—´æˆ³ä»£æ›¿äº†è®¡æ•°å™¨ã€‚äºæ˜¯å°±éšæ—¶é—´æˆ³å˜åŒ–ç”Ÿæˆä¸åŒå¯†ç ã€‚</p>

<!--more-->

<h2 id="working">Working</h2>

<p>è€Œå®é™…ä¸Š Google Authentication ä½¿ç”¨ TOTPã€‚æ ¸å¿ƒç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆã€‚</p>

<ul>
  <li>å…±äº«å¯†é’¥</li>
  <li>è¾“å…¥(æ—¶é—´æˆ³)</li>
  <li>ç­¾å</li>
</ul>

<h3 id="å…±äº«å¯†é’¥">å…±äº«å¯†é’¥</h3>

<p>å…±äº«å¯†é’¥ç”¨äºåœ¨å…¶å®ƒå®¢æˆ·ç«¯è·å¾—å¯†ç ï¼Œå¯ä»¥æ‰‹åŠ¨è¾“å…¥ï¼Œå¯ä»¥é€šè¿‡é“¾æ¥æˆ–è€…äºŒç»´ç è·å¾—ã€‚</p>

<p>æ³¨æ„å¯†é’¥ä¼šè¢«Base32ç¼–ç ï¼Œæ‰€ä»¥è¦å»é™¤ç©ºæ ¼å¹¶è½¬æ¢æˆå¤§å†™ã€‚ç„¶å ä¿è¯å¤„ç†åçš„å¯†é’¥ä½æ•°æ˜¯8çš„å€æ•°ã€‚</p>

<p>Google æœåŠ¡ä½¿ç”¨4ä½8ç»„å…±32ä½çš„å¯†é’¥ã€‚å…¶å®ƒä½¿ç”¨ Google Authentication çš„ä¸å°½ç›¸åŒï¼Œåƒ GitHub åˆ™æ˜¯16ä½çš„å¯†é’¥ã€‚</p>

<p>å¯†é’¥å°†URLè½¬æ¢æˆäºŒç»´ç æ–¹ä¾¿æ‰‹æœºæˆ–å…¶å®ƒè®¾å¤‡ä½¿ç”¨æ—¶å€™éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>otpauth://TYPE/LABEL?PARAMETERS
</code></pre></div></div>

<p>æ¯”å¦‚è¿™æ ·ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>otpauth://totp/Example:alice@google.com?secret=JBSWY3DPEHPK3PXP&amp;issuer=Example
</code></pre></div></div>

<p>è¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒ<a href="https://github.com/google/google-authenticator/wiki/Key-Uri-Format">Key Uri Format</a></p>

<h3 id="è¾“å…¥æ—¶é—´æˆ³">è¾“å…¥(æ—¶é—´æˆ³)</h3>

<p>TOTP é‡‡ç”¨æ—¶é—´æˆ³ä½œä¸ºå˜é‡ï¼Œä¸éœ€è¦ä¸æœåŠ¡å™¨äº¤äº’å°±å¯ä»¥å¾—åˆ°å¯†ç ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•é€‰å–å‘¢ï¼Ÿ</p>

<p>å› ä¸ºæ—¶é—´æ¯æ—¶æ¯åˆ»éƒ½åœ¨å˜åŒ–ï¼Œå¦‚æœé€‰æ‹©ä¸€ä¸ªå˜åŒ–å¤ªå¿«çš„ inputï¼ˆä¾‹å¦‚ä»æŸä¸€æ—¶é—´ç‚¹å¼€å§‹çš„ç§’æ•°ï¼‰ï¼Œé‚£ä¹ˆç”¨æˆ·æ¥ä¸åŠè¾“å…¥å¯†ç ã€‚å¦‚æœé€‰æ‹©ä¸€ä¸ªå˜åŒ–å¤ªæ…¢çš„ inputï¼ˆä¾‹å¦‚ä»æŸä¸€æ—¶é—´ç‚¹å¼€å§‹çš„å°æ—¶æ•°ï¼‰ï¼Œé‚£ä¹ˆç¬¬ä¸‰æ–¹æ”»å‡»è€…å°±æœ‰å……è¶³çš„æ—¶é—´å»å°è¯•æ‰€æœ‰å¯èƒ½çš„ä¸€æ¬¡æ€§å¯†ç ï¼ˆè¯•æƒ³6ä½æ•°å­—çš„ä¸€æ¬¡æ€§å¯†ç ä»…ä»…æœ‰10\^6ç§ç»„åˆï¼‰ï¼Œé™ä½äº†å¯†ç çš„å®‰å…¨æ€§ã€‚</p>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œå˜åŒ–å¤ªæ…¢çš„ input è¿˜ä¼šå¯¼è‡´å¦ä¸€ä¸ªé—®é¢˜ã€‚å¦‚æœç”¨æˆ·éœ€è¦åœ¨çŸ­æ—¶é—´å†…ä¸¤æ¬¡ç™»å½•è´¦æˆ·ï¼Œç”±äºå¯†ç æ˜¯ä¸€æ¬¡æ€§çš„ä¸å¯é‡ç”¨ï¼Œç”¨æˆ·å¿…é¡»ç­‰åˆ°ä¸‹ä¸€ä¸ªä¸€æ¬¡æ€§å¯†ç è¢«ç”Ÿæˆæ—¶æ‰èƒ½ç™»å½•ï¼Œè¿™æ„å‘³ç€æœ€å¤šéœ€è¦ç­‰å¾…59åˆ†59ç§’ï¼è¿™æ˜¾ç„¶ä¸å¯æ¥å—ã€‚</p>

<p>ç»¼åˆä»¥ä¸Šè€ƒè™‘ï¼ŒGoogleé€‰æ‹©äº†30ç§’ä½œä¸ºæ—¶é—´ç‰‡ï¼Œæ—¶é—´æˆ³è¾“å…¥çš„æ•°å€¼ä¸ºä»Unix epochï¼ˆ1970å¹´1æœˆ1æ—¥ 00:00:00ï¼‰æ¥ç»å†çš„30ç§’çš„ä¸ªæ•°ã€‚</p>

<p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œç”±äºç½‘ç»œå»¶æ—¶ï¼Œç”¨æˆ·è¾“å…¥å»¶è¿Ÿç­‰å› ç´ ï¼Œå¯èƒ½å½“æœåŠ¡å™¨ç«¯æ¥æ”¶åˆ°ä¸€æ¬¡æ€§å¯†ç æ—¶ï¼Œinputçš„æ•°å€¼å·²ç»æ”¹å˜ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´æœåŠ¡å™¨è®¡ç®—çš„ä¸€æ¬¡æ€§å¯†ç å€¼ä¸ç”¨æˆ·è¾“å…¥çš„ä¸åŒï¼ŒéªŒè¯å¤±è´¥ã€‚è§£å†³è¿™ä¸ªé—®é¢˜ä¸ªä¸€ä¸ªæ–¹æ³•æ˜¯ï¼ŒæœåŠ¡å™¨è®¡ç®—å½“å‰æ—¶é—´ç‰‡ä»¥åŠå‰é¢çš„nä¸ªæ—¶é—´ç‰‡å†…çš„ä¸€æ¬¡æ€§å¯†ç å€¼ï¼Œåªè¦å…¶ä¸­æœ‰ä¸€ä¸ªä¸ç”¨æˆ·è¾“å…¥çš„å¯†ç ç›¸åŒï¼Œåˆ™éªŒè¯é€šè¿‡ã€‚å½“ç„¶ï¼Œnä¸èƒ½å¤ªå¤§ï¼Œå¦åˆ™ä¼šé™ä½å®‰å…¨æ€§ã€‚</p>

<h3 id="ç­¾å">ç­¾å</h3>

<p>ç­¾åä½¿ç”¨ HMAC-SHA1 ç®—æ³•ã€‚ä»¥ä¸€ä¸ªå¯†é’¥å’Œä¸€ä¸ªæ¶ˆæ¯ä¸ºè¾“å…¥ï¼Œç”Ÿæˆä¸€ä¸ªæ¶ˆæ¯æ‘˜è¦ä½œä¸ºè¾“å‡ºã€‚</p>

<p>å› ä¸ºç®—æ³•æ˜¯å•å‘æ•£åˆ—åŠ å¯†ï¼Œç»“æœä¸å¯é€†ï¼Œè¿™æ ·åœ¨ä¿è¯å¯†é’¥ä¸è¢«ç¬¬ä¸‰è€…çŸ¥é“çš„æƒ…å†µä¸‹ï¼Œåªæœ‰ä½¿ç”¨ç›¸åŒå¯†é’¥å’Œè¾“å…¥(æ—¶é—´æˆ³)æ‰ä¼šå¾—åˆ°ç›¸åŒç»“æœï¼ŒæœåŠ¡ç«¯æ‰èƒ½åˆ¤æ–­å®¢æˆ·ç«¯æ˜¯åˆæ³•ç™»å½•ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>h = hmac.new(key, msg, hashlib.sha1).digest()
</code></pre></div></div>

<h2 id="algorithm">Algorithm</h2>

<p><img src="/imgs/201709-3WpWR.jpg" alt="" /></p>

<p>ä¼ªä»£ç ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function GoogleAuthenticatorCode(string secret)
    key := base32decode(secret)
    message := floor(current Unix time / 30)
    hash := HMAC-SHA1(key, message)
    offset := last nibble of hash
    truncatedHash := hash[offset..offset+3]  //4 bytes starting at the offset
    Set the first bit of truncatedHash to zero  //remove the most significant bit
    code := truncatedHash mod 1000000
    pad code with 0 until length of code is 6
    return code
</code></pre></div></div>

<p>Python å®ç°:</p>

<pre><code class="language-Python">import hmac
import base64
import struct
import hashlib
import time
import sys

def get_hotp_token(secret, intervals_no):
    key = base64.b32decode(secret)
    msg = struct.pack("&gt;Q", intervals_no)
    h = hmac.new(key, msg, hashlib.sha1).digest()
    o = h[len(h)-1] &amp; 0x0f
    h = (struct.unpack("&gt;I", h[o:o + 4])[0] &amp; 0x7fffffff) % 1000000
    return h

def get_totp_token(secret):
    intervals_no = int(time.time()) // 30
    totp_token = get_hotp_token(secret, intervals_no)
    return totp_token

if __name__ == '__main__':
    if len(sys.argv) != 2:
        print('Must specify key to use.')
        exit(1)
    Sec = sys.argv[1]
    Sec = Sec.replace(' ', '').upper()
    if len(Sec) % 8 != 0:
        print('Illegal base32 data at input byte %d' % ((len(Sec)//8+1)*8))
        exit(1)
    validation_code = get_totp_token(Sec)
    print('Code: %06d  (%02d second(s) remaining.)' %
          (validation_code, 30 - int(time.time()) % 30))
</code></pre>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªGoçš„å®ç°ï¼Œ<a href="https://gist.github.com/zzir/4346340d9f4122227d2031068a28248e">ç‚¹æˆ‘ä¼ é€</a></p>

<h2 id="see-also">See Also</h2>
<p>https://en.wikipedia.org/wiki/Google_Authenticator  <br />
https://blog.seetee.me/post/2011/google-two-step-verification/  <br />
https://garbagecollected.org/2014/09/14/how-google-authenticator-works/  <br />
https://security.stackexchange.com/questions/35157/how-does-google-authenticator-work</p>

    </div>

    <a class="u-url" href="/2017/google-authentication.html" hidden></a>
</article>

<div class="post-tags">
    
    <a>Google</a>
    
    <a>2FA</a>
    
    <a>Python</a>
    
</div>

<div class="pagination">
    <ul>
        
        <li class="prev">
            <a href="/2017/pyhon-zmq.html" title="PREV: Python ZMQ">
                â€¹ Python ZMQ
            </a>
        </li>
        
        
        <li class="next">
            <a href="/2018/caddy-server-ratelimit.html" title="NEXT: Caddy Server è®¿é—®é¢‘ç‡é™åˆ¶">
                â€º Caddy Server è®¿é—®é¢‘ç‡é™åˆ¶
            </a>
        </li>
        
    </ul>
</div>
    </div>
</main><footer>
    <p class="post-author"><a href="/">ZZIR</a></p>
    <p class="beian">
        
        <span>
            <img src="/assets/imgs/beian.png">
            <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=33010902002287">æµ™å…¬ç½‘å®‰å¤‡33010902002287å·</a>
        </span>
        ãƒ»ï¸
        <span><a href="http://beian.miit.gov.cn/">æµ™ICPå¤‡19040093å·</a></span>
        
    </p>
</footer>
<script defer src="/assets/js/katex/katex.min.js" type="text/javascript"></script>
<script defer src="/assets/js/katex/auto-render.min.js" type="text/javascript"></script>
<script src="/assets/js/zooming.min.js" type="text/javascript"></script>
<script src="/assets/js/highlight.pack.js" type="text/javascript"></script>
<script>
    // zooming
    const zooming = new Zooming({
        customSize: '100%',
    });
    zooming.listen('.paragraph img');
    zooming.listen('.content img');
    zooming.listen('.post-content img');

    // highlight
    hljs.initHighlightingOnLoad();

    // katex
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false},
                {left: "\\(", right: "\\)", display: false},
                {left: "\\[", right: "\\]", display: true}
            ]
        });
    });

    // back display
    function getScrollTop() {
        var scrollTop = 0;
        if (document.documentElement && document.documentElement.scrollTop) {
            scrollTop = document.documentElement.scrollTop;
        } else if (document.body) {
            scrollTop = document.body.scrollTop;
        }
        return scrollTop;
    }

    window.onscroll = function () {
        if (getScrollTop() === 0) {
            document.getElementById("post-back").style.display = "block";
        }
    }
</script>


<script>
    // google analytics
    window.ga = window.ga || function () {
        (ga.q = ga.q || []).push(arguments)
    };
    ga.l = +new Date;
    ga('create', 'UA-121779014-1', 'auto');
    ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>